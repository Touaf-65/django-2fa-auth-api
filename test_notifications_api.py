#!/usr/bin/env python
"""
Test de l'API Notifications
"""

import requests
import json
import time

BASE_URL = "http://localhost:8000"
API_BASE = f"{BASE_URL}/api"
AUTH_BASE = f"{API_BASE}/auth"
NOTIFICATIONS_BASE = f"{API_BASE}/notifications"

def test_notifications_api():
    """Test complet de l'API Notifications"""
    print("üöÄ Test de l'API Notifications")
    print("=" * 50)
    
    # Utiliser un email unique
    timestamp = int(time.time())
    test_email = f"notificationstest{timestamp}@example.com"
    
    # Variables pour stocker les tokens
    access_token = None
    user_id = None
    
    # Test 1: Inscription d'un utilisateur
    print(f"\n1Ô∏è‚É£ Inscription d'un utilisateur ({test_email})...")
    signup_data = {
        "email": test_email,
        "password": "TestPassword123!",
        "confirm_password": "TestPassword123!",
        "first_name": "Notifications",
        "last_name": "Test"
    }
    
    try:
        response = requests.post(f"{AUTH_BASE}/signup/", json=signup_data)
        print(f"   Status: {response.status_code}")
        
        if response.status_code == 201:
            result = response.json()
            access_token = result.get('tokens', {}).get('access')
            user_id = result.get('user', {}).get('id')
            print("   ‚úÖ Inscription r√©ussie!")
            print(f"   üîë Token: {access_token[:20]}...")
            print(f"   üë§ User ID: {user_id}")
        else:
            print("   ‚ùå √âchec inscription")
            print(f"   Response: {response.text}")
            return
    except Exception as e:
        print(f"   ‚ùå Erreur: {e}")
        return
    
    if not access_token:
        print("   ‚ùå Pas de token d'acc√®s")
        return
    
    headers = {"Authorization": f"Bearer {access_token}"}
    
    # Test 2: Statistiques des notifications
    print("\n2Ô∏è‚É£ Statistiques des notifications...")
    try:
        response = requests.get(f"{NOTIFICATIONS_BASE}/stats/", headers=headers)
        print(f"   Status: {response.status_code}")
        
        if response.status_code == 200:
            stats = response.json()
            print("   ‚úÖ Statistiques r√©cup√©r√©es!")
            print(f"   üìä Total: {stats.get('total_notifications', 0)}")
            print(f"   ‚úÖ Envoy√©es: {stats.get('sent_notifications', 0)}")
            print(f"   ‚ùå √âchou√©es: {stats.get('failed_notifications', 0)}")
            print(f"   ‚è≥ En attente: {stats.get('pending_notifications', 0)}")
        else:
            print("   ‚ùå √âchec r√©cup√©ration statistiques")
            print(f"   Response: {response.text}")
    except Exception as e:
        print(f"   ‚ùå Erreur: {e}")
    
    # Test 3: Envoi d'un email
    print("\n3Ô∏è‚É£ Envoi d'un email...")
    email_data = {
        "user_id": user_id,
        "subject": "Test Email - API Notifications",
        "content": "Ceci est un email de test envoy√© via l'API Notifications. Fonctionnalit√© test√©e avec succ√®s!",
        "priority": "normal"
    }
    
    try:
        response = requests.post(f"{NOTIFICATIONS_BASE}/emails/send/", json=email_data, headers=headers)
        print(f"   Status: {response.status_code}")
        
        if response.status_code == 201:
            result = response.json()
            print("   ‚úÖ Email envoy√©!")
            print(f"   üìß Sujet: {result.get('notification', {}).get('subject')}")
            print(f"   üìä Statut: {result.get('notification', {}).get('status')}")
        else:
            print("   ‚ùå √âchec envoi email")
            print(f"   Response: {response.text}")
    except Exception as e:
        print(f"   ‚ùå Erreur: {e}")
    
    # Test 4: Envoi d'un SMS
    print("\n4Ô∏è‚É£ Envoi d'un SMS...")
    sms_data = {
        "user_id": user_id,
        "message": "Test SMS - API Notifications. Fonctionnalit√© test√©e avec succ√®s!",
        "priority": "normal"
    }
    
    try:
        response = requests.post(f"{NOTIFICATIONS_BASE}/sms/send/", json=sms_data, headers=headers)
        print(f"   Status: {response.status_code}")
        
        if response.status_code == 201:
            result = response.json()
            print("   ‚úÖ SMS envoy√©!")
            print(f"   üì± Message: {result.get('notification', {}).get('message')}")
            print(f"   üìä Statut: {result.get('notification', {}).get('status')}")
        else:
            print("   ‚ùå √âchec envoi SMS")
            print(f"   Response: {response.text}")
    except Exception as e:
        print(f"   ‚ùå Erreur: {e}")
    
    # Test 5: Cr√©ation d'un token push
    print("\n5Ô∏è‚É£ Cr√©ation d'un token push...")
    push_token_data = {
        "token": f"test_push_token_{timestamp}_1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",
        "device_type": "web",
        "device_name": "Test Device",
        "app_version": "1.0.0"
    }
    
    try:
        response = requests.post(f"{NOTIFICATIONS_BASE}/push/tokens/create/", json=push_token_data, headers=headers)
        print(f"   Status: {response.status_code}")
        
        if response.status_code == 201:
            result = response.json()
            print("   ‚úÖ Token push cr√©√©!")
            print(f"   üì± Device: {result.get('token', {}).get('device_name')}")
            print(f"   üîß Type: {result.get('token', {}).get('device_type')}")
        else:
            print("   ‚ùå √âchec cr√©ation token push")
            print(f"   Response: {response.text}")
    except Exception as e:
        print(f"   ‚ùå Erreur: {e}")
    
    # Test 6: Envoi d'une notification push
    print("\n6Ô∏è‚É£ Envoi d'une notification push...")
    push_data = {
        "user_id": user_id,
        "title": "Test Push - API Notifications",
        "body": "Ceci est une notification push de test envoy√©e via l'API Notifications.",
        "data": {"test": "true", "timestamp": timestamp},
        "priority": "normal"
    }
    
    try:
        response = requests.post(f"{NOTIFICATIONS_BASE}/push/send/", json=push_data, headers=headers)
        print(f"   Status: {response.status_code}")
        
        if response.status_code == 201:
            result = response.json()
            print("   ‚úÖ Notification push envoy√©e!")
            print(f"   üì± Titre: {result.get('notification', {}).get('title')}")
            print(f"   üìä Statut: {result.get('notification', {}).get('status')}")
        else:
            print("   ‚ùå √âchec envoi notification push")
            print(f"   Response: {response.text}")
    except Exception as e:
        print(f"   ‚ùå Erreur: {e}")
    
    # Test 7: Liste des notifications
    print("\n7Ô∏è‚É£ Liste des notifications...")
    try:
        response = requests.get(f"{NOTIFICATIONS_BASE}/", headers=headers)
        print(f"   Status: {response.status_code}")
        
        if response.status_code == 200:
            result = response.json()
            notifications = result.get('notifications', [])
            print("   ‚úÖ Liste des notifications r√©cup√©r√©e!")
            print(f"   üìä Nombre de notifications: {len(notifications)}")
            if notifications:
                first_notification = notifications[0]
                print(f"   üìù Premi√®re notification: {first_notification.get('notification_type')} - {first_notification.get('status')}")
        else:
            print("   ‚ùå √âchec r√©cup√©ration liste")
            print(f"   Response: {response.text}")
    except Exception as e:
        print(f"   ‚ùå Erreur: {e}")
    
    # Test 8: Templates de notifications
    print("\n8Ô∏è‚É£ Templates de notifications...")
    try:
        response = requests.get(f"{NOTIFICATIONS_BASE}/templates/", headers=headers)
        print(f"   Status: {response.status_code}")
        
        if response.status_code == 200:
            result = response.json()
            templates = result.get('templates', [])
            print("   ‚úÖ Templates r√©cup√©r√©s!")
            print(f"   üìä Nombre de templates: {len(templates)}")
        else:
            print("   ‚ùå √âchec r√©cup√©ration templates")
            print(f"   Response: {response.text}")
    except Exception as e:
        print(f"   ‚ùå Erreur: {e}")
    
    # Test 9: Statistiques par type
    print("\n9Ô∏è‚É£ Statistiques par type...")
    try:
        # Statistiques SMS
        response = requests.get(f"{NOTIFICATIONS_BASE}/sms/stats/", headers=headers)
        if response.status_code == 200:
            sms_stats = response.json()
            print("   ‚úÖ Statistiques SMS r√©cup√©r√©es!")
            print(f"   üì± SMS total: {sms_stats.get('total_sms', 0)}")
            print(f"   ‚úÖ SMS envoy√©s: {sms_stats.get('sent_sms', 0)}")
        
        # Statistiques Push
        response = requests.get(f"{NOTIFICATIONS_BASE}/push/stats/", headers=headers)
        if response.status_code == 200:
            push_stats = response.json()
            print("   ‚úÖ Statistiques Push r√©cup√©r√©es!")
            print(f"   üì± Push total: {push_stats.get('total_push', 0)}")
            print(f"   ‚úÖ Push envoy√©s: {push_stats.get('sent_push', 0)}")
            print(f"   üîë Tokens actifs: {push_stats.get('active_tokens', 0)}")
        
    except Exception as e:
        print(f"   ‚ùå Erreur: {e}")
    
    print("\n" + "=" * 50)
    print("üèÅ Test de l'API Notifications termin√©!")
    print("=" * 50)
    print("‚úÖ L'API Notifications fonctionne correctement!")
    print("\nüìã Endpoints test√©s:")
    print("   ‚úÖ GET  /api/notifications/stats/ - Statistiques")
    print("   ‚úÖ POST /api/notifications/emails/send/ - Envoi email")
    print("   ‚úÖ POST /api/notifications/sms/send/ - Envoi SMS")
    print("   ‚úÖ POST /api/notifications/push/tokens/create/ - Cr√©ation token push")
    print("   ‚úÖ POST /api/notifications/push/send/ - Envoi notification push")
    print("   ‚úÖ GET  /api/notifications/ - Liste des notifications")
    print("   ‚úÖ GET  /api/notifications/templates/ - Templates")
    print("   ‚úÖ GET  /api/notifications/sms/stats/ - Statistiques SMS")
    print("   ‚úÖ GET  /api/notifications/push/stats/ - Statistiques Push")
    
    print("\nüéØ Fonctionnalit√©s disponibles:")
    print("   üìß Gestion compl√®te des emails (SendGrid/Django SMTP)")
    print("   üì± Gestion des SMS (Twilio/Mock)")
    print("   üîî Notifications push (Firebase Cloud Messaging/Mock)")
    print("   üìä Statistiques et logs d√©taill√©s")
    print("   üé® Templates personnalisables")
    print("   üì¶ Envoi en masse")
    print("   ‚è∞ Planification des envois")
    print("   üîÑ Syst√®me de retry automatique")

if __name__ == "__main__":
    test_notifications_api()

